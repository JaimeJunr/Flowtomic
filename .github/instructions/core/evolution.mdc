---
description: Sistema de pr√©-regra para consolida√ß√£o de conhecimento evolucional e padr√µes comprovados
alwaysApply: false
---

# üß† Evolution - Li√ß√µes Aprendidas e Padr√µes Consolidados

## üö® **Diretrizes Fundamentais**

### 1. Fun√ß√£o como Pr√©-Regra

**SEMPRE entenda** que este arquivo:

- **Recebe**: Conhecimento consolidado da mem√≥ria de trabalho
- **Organiza**: Padr√µes para facilitar movimenta√ß√£o posterior
- **Prepara**: Conte√∫do para ser movido para regras espec√≠ficas
- **Mant√©m**: Fluxo de conhecimento estruturado e organizado

### 2. Processo de Consolida√ß√£o

**SEMPRE siga** este fluxo de consolida√ß√£o:

1. **SEMPRE colete** nova informa√ß√£o no `activeContext.md`
2. **SEMPRE teste** e comprove em contexto real
3. **SEMPRE mova** para `evolution.mdc` como pr√©-regra consolidada
4. **SEMPRE refine** e organize conhecimento no espa√ßo intermedi√°rio

## 1. Padr√µes de Desenvolvimento TDD

> **üìã MOVIMENTADO**: Padr√µes TDD consolidados foram movidos para `tdd-rule.mdc`
>
> **Localiza√ß√£o**: `.cursor/rules/core/development/tdd-rule.mdc`
>
> **Padr√µes Movidos**:
>
> - TDD com Evid√™ncias Reais e Integra√ß√£o de Servi√ßos
> - Refatora√ß√£o Clean Code com TDD
> - TDD para Corre√ß√£o de Bugs
>
> **Status**: ‚úÖ Movimenta√ß√£o conclu√≠da - padr√µes consolidados na regra espec√≠fica

## 2. Padr√µes de Investiga√ß√£o e Debugging

> **üìã MOVIMENTADO**: Padr√µes de investiga√ß√£o e debugging consolidados foram movidos para `debugging-rule.mdc`
>
> **Localiza√ß√£o**: `.cursor/rules/core/development/debugging-rule.mdc`
>
> **Padr√µes Movidos**:
>
> - Investiga√ß√£o de Erro de Rota Est√°tica
> - Debugging e Logs Estrat√©gicos
> - T√©cnicas de Investiga√ß√£o Sistem√°tica
> - Valida√ß√£o com Evid√™ncias Reais
>
> **Status**: ‚úÖ Movimenta√ß√£o conclu√≠da - padr√µes consolidados na regra espec√≠fica

## 3. Padr√µes de Teste Rails e RSpec

> **üìã MOVIMENTADO**: Padr√µes de testes Rails e RSpec consolidados foram movidos para `rails-testing-rule.mdc`
>
> **Localiza√ß√£o**: `.cursor/rules/ruby/rails-testing-rule.mdc`
>
> **Padr√µes Movidos**:
>
> - Estrutura RSpec e Qualidade de Testes
> - Testes TDD Estrat√©gicos
> - Integra√ß√£o com Teaspoon (JavaScript/CoffeeScript)
> - Padr√µes de Qualidade e M√©tricas
>
> **Status**: ‚úÖ Movimenta√ß√£o conclu√≠da - padr√µes consolidados na regra espec√≠fica

## 4. Padr√µes de Arquitetura Rails

> **üìã MOVIMENTADO**: Padr√µes de arquitetura Rails consolidados foram movidos para `rails-code.mdc`
>
> **Localiza√ß√£o**: `.cursor/rules/ruby/rails-code.mdc`
>
> **Padr√µes Movidos**:
>
> - Heran√ßa Rails e Comportamento Padr√£o
> - Preserva√ß√£o de Contexto
> - Padr√µes de Inicializa√ß√£o e Contexto
>
> **Status**: ‚úÖ Movimenta√ß√£o conclu√≠da - padr√µes consolidados na regra espec√≠fica

## 5. Padr√µes de Qualidade e Fluxo de Trabalho

### 5.1 Rubocop Integration

**Contexto**: Corre√ß√£o autom√°tica de problemas de formata√ß√£o

**Padr√£o Comprovado**:

```bash
# ‚úÖ CORRETO: Corre√ß√£o autom√°tica
docker-compose run --rm --no-deps test rubocop app/pricings/application_pricing.rb --autocorrect
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** corre√ß√£o autom√°tica do Rubocop quando poss√≠vel
2. **SEMPRE execute** Rubocop ap√≥s mudan√ßas
3. **SEMPRE mantenha** padr√µes de c√≥digo consistentes

### 5.2 Fluxo de Trabalho e Valida√ß√£o com Evid√™ncias

**Contexto**: Fluxo sistem√°tico de investiga√ß√£o, planejamento e implementa√ß√£o

**Padr√£o Comprovado**:

```text
INFO Mode ‚Üí Investiga√ß√£o pura e coleta de informa√ß√µes
    ‚Üì
PLAN Mode ‚Üí Planejamento estrat√©gico e especifica√ß√£o t√©cnica
    ‚Üì
ACT Mode ‚Üí Implementa√ß√£o controlada com logs e valida√ß√£o
```

```ruby
# ‚úÖ CORRETO: Valida√ß√£o com evid√™ncias reais
log_debug("Moeda convertida: #{from_currency} (original: #{money.currency.id})")
log_debug("Taxa de c√¢mbio: #{rate}")
log_debug("Valor convertido: #{converted_amount}")
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE investigue** antes de planejar
2. **SEMPRE valide** com dados reais
3. **SEMPRE use** logs estrat√©gicos - fornecem evid√™ncias do comportamento
4. **SEMPRE implemente** com controle - implementa√ß√£o controlada com logs e valida√ß√£o

### 5.3 Integra√ß√£o com Servi√ßos Existentes

**Contexto**: Uso do `CurrencyService` existente

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Integrar com servi√ßo existente
CurrencyService.convert_dollar_currency_code_by_fund(@fund, money.currency.id)
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE verifique** se j√° existe servi√ßo antes de implementar
2. **SEMPRE reutilize** c√≥digo existente - n√£o reimplemente funcionalidade
3. **SEMPRE integre** com servi√ßos existentes de forma limpa

### 5.4 Investiga√ß√£o Sistem√°tica e Mapeamento de Fluxo

**Contexto**: Investiga√ß√£o completa de problemas e mapeamento de sistemas complexos

**Padr√£o Comprovado**:

```text
1. Mapeamento do Fluxo ‚Üí Entender hierarquia completa do sistema
2. Identifica√ß√£o do Problema ‚Üí Localizar exatamente onde est√° o bug
3. An√°lise de Impacto ‚Üí Determinar escopo e tipos afetados
4. Valida√ß√£o da Solu√ß√£o ‚Üí Confirmar que corre√ß√£o √© simples e direta
5. Prepara√ß√£o para Implementa√ß√£o ‚Üí Identificar pontos para logging e testes
```

```text
PortfolioPreviewPublisherJob
‚îú‚îÄ‚îÄ PortfolioFront (estrat√©gia) ‚Üí ExplosionHashFront (OnlinePricing)
‚îî‚îÄ‚îÄ PortfolioBack (cust√≥dia) ‚Üí ExplosionHashBack (DbPricing)

Tipos de Portf√≥lio:
- Front: Baseado em estrat√©gias (Strategy::OperationItem)
- Back: Baseado em cust√≥dia (Custody)
- Explodido: expand_positions: true (mostra posi√ß√µes dos fundos investidos)
- N√£o-explodido: expand_positions: false (mostra apenas posi√ß√µes diretas)
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE entenda** fluxo hier√°rquico antes de agir
2. **SEMPRE mapeie** estrutura completa do sistema
3. **SEMPRE entenda** hierarquia de prioridade - sistema usa fallbacks inteligentes em ordem espec√≠fica
4. **SEMPRE valide** cada n√≠vel individualmente

**Aplica√ß√£o Futura**:

1. **SEMPRE execute** Rubocop ap√≥s mudan√ßas
2. **SEMPRE use** corre√ß√£o autom√°tica quando poss√≠vel
3. **SEMPRE mantenha** padr√µes de c√≥digo consistentes
4. **SEMPRE siga** fluxo INFO ‚Üí PLAN ‚Üí ACT
5. **SEMPRE valide** com dados reais
6. **SEMPRE implemente** logs estrat√©gicos para evid√™ncias
7. **SEMPRE base** valida√ß√£o em dados, n√£o suposi√ß√µes
8. **SEMPRE verifique** servi√ßos existentes antes de implementar
9. **SEMPRE reutilize** c√≥digo existente quando poss√≠vel
10. **SEMPRE integre** com servi√ßos existentes de forma limpa
11. **SEMPRE mapeie** fluxo completo antes de investigar problemas
12. **SEMPRE identifique** tipos de componente e suas responsabilidades
13. **SEMPRE entenda** hierarquia de fallbacks do sistema
14. **SEMPRE valide** cada n√≠vel da hierarquia individualmente

## 6. M√©tricas de Evolu√ß√£o

### 6.1 Padr√µes Consolidados

- **5 padr√µes principais** (compactados de 26)
- **5 categorias principais** de li√ß√µes aprendidas (compactadas de 16)
- **20 aplica√ß√µes espec√≠ficas** (compactadas de 35)

### 6.2 Pr√≥ximos Padr√µes a Desenvolver

1. **SEMPRE desenvolva** padr√µes de performance - otimiza√ß√£o de queries e cache
2. **SEMPRE desenvolva** padr√µes de seguran√ßa - valida√ß√£o e sanitiza√ß√£o de dados
3. **SEMPRE desenvolva** padr√µes de deploy - estrat√©gias de deploy e rollback
4. **SEMPRE desenvolva** padr√µes de monitoramento - logs e m√©tricas de produ√ß√£o
5. **SEMPRE desenvolva** padr√µes de rota - configura√ß√£o e troubleshooting de rotas Rails

## 7. Padr√µes de CoffeeScript e Teaspoon

### 7.1 Descoberta de CoffeeScript e Teaspoon no Sistema Rails

**Contexto**: Descoberta de infraestrutura de testes JavaScript/CoffeeScript durante investiga√ß√£o do ticket CAP-6915

**Padr√£o Comprovado**:

```bash
# ‚úÖ CORRETO: Execu√ß√£o de testes JavaScript/CoffeeScript
bundle exec teaspoon --suite=reconcile

# Resultado: 331 exemplos passaram sem falhas
```

```coffeescript
# ‚úÖ CORRETO: Estrutura de teste Teaspoon para CoffeeScript
describe 'Anbima5GalgoService', ->
  beforeEach ->
    @fund = { id: 1, name: 'Test Fund' }
    @portfolioType = 'galgo'
    @opts = { test: true }
    @service = new Anbima5GalgoService(@fund, @portfolioType, @opts)

  describe 'constructor', ->
    it 'should initialize correctly', ->
      expect(@service.fund).toEqual(@fund)
      expect(@service.portfolioType).toEqual(@portfolioType)
      expect(@service.opts).toEqual(@opts)
```

**Descobertas**:

1. **SEMPRE reconhe√ßa** infraestrutura existente - Teaspoon configurado e funcionando
2. **SEMPRE valide** suite reconcile - 331 testes passando sem falhas
3. **SEMPRE identifique** arquivos CoffeeScript - servi√ßos de concilia√ß√£o em CoffeeScript
4. **SEMPRE verifique** configura√ß√£o v√°lida - `spec/teaspoon_env.rb` e `spec/reconcile_spec_helper.coffee`

## 8. Padr√µes Prontos para Movimenta√ß√£o

### 8.1 Candidatos para Regras Espec√≠ficas

**Padr√µes de TDD** ‚Üí `tdd-rule.mdc` ou `testing-rule.mdc`

1. **SEMPRE mova** TDD com evid√™ncias reais
2. **SEMPRE mova** refatora√ß√£o Clean Code com TDD
3. **SEMPRE mova** TDD para corre√ß√£o de bugs

**Padr√µes de Investiga√ß√£o** ‚Üí `debugging-rule.mdc` ou `investigation-rule.mdc`

1. **SEMPRE mova** investiga√ß√£o de erro de rota est√°tica
2. **SEMPRE mova** debugging e logs estrat√©gicos

**Padr√µes de Testes Rails** ‚Üí `rspec-rule.mdc` ou `rails-testing-rule.mdc`

1. **SEMPRE mova** estrutura RSpec e qualidade de testes
2. **SEMPRE mova** testes TDD estrat√©gicos

**Padr√µes de Arquitetura Rails** ‚Üí `rails-architecture-rule.mdc`

1. **SEMPRE mova** heran√ßa Rails e comportamento padr√£o
2. **SEMPRE mova** preserva√ß√£o de contexto

**Padr√µes de Qualidade** ‚Üí `quality-rule.mdc` ou `workflow-rule.mdc`

1. **SEMPRE mova** Rubocop integration
2. **SEMPRE mova** fluxo de trabalho e valida√ß√£o com evid√™ncias
3. **SEMPRE mova** integra√ß√£o com servi√ßos existentes

**Padr√µes de CoffeeScript** ‚Üí `coffeescript-rule.mdc` ou `javascript-testing-rule.mdc`

1. **SEMPRE mova** descoberta de CoffeeScript e Teaspoon no sistema Rails

**Padr√µes de Service Objects** ‚Üí `service-objects-rule.mdc` ou `rails-services-rule.mdc`

1. **SEMPRE mova** namespace por dom√≠nio Mellon
2. **SEMPRE mova** inicializa√ß√£o com autentica√ß√£o
3. **SEMPRE mova** delega√ß√£o limpa
4. **SEMPRE mova** configura√ß√£o condicional
5. **SEMPRE mova** m√©todos de classe utilit√°rios
6. **SEMPRE mova** factory methods privados
7. **SEMPRE mova** broadcasting com ActionCable

## 9. Padr√µes de Service Objects - Portfolio Services

### 9.1 Padr√£o de Namespace por Dom√≠nio Mellon

**Contexto**: Implementa√ß√£o de services organizados por dom√≠nio de neg√≥cio

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Namespace Mellon para dom√≠nio espec√≠fico
class Mellon::PortfolioService < ApplicationService
  def initialize
    connector.authenticate
  end

  def notifications(date)
    connector.notifications(date)
  end
end

# ‚úÖ CORRETO: Service principal para opera√ß√µes gerais
class PortfolioService < ApplicationService
  def self.front_office(opts, portfolio_clazz = Strategy::Portfolio)
    portfolio = portfolio_clazz.new(opts)
    portfolio.json_exchange_rates = true
    portfolio.load_front_positions(opts)
    portfolio
  end
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE organize** por dom√≠nio - namespaces previnem conflitos e organizam funcionalidades
2. **SEMPRE use** heran√ßa ApplicationService - base comum para todos os services
3. **SEMPRE mantenha** responsabilidade √∫nica - cada service foca em seu dom√≠nio espec√≠fico
4. **SEMPRE prepare** para escalabilidade - estrutura preparada para novos dom√≠nios

### 9.2 Padr√£o de Inicializa√ß√£o com Autentica√ß√£o

**Contexto**: Autentica√ß√£o autom√°tica na inicializa√ß√£o de services

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Autentica√ß√£o autom√°tica na inicializa√ß√£o
def initialize
  connector.authenticate
end

# ‚úÖ CORRETO: Factory method com lazy loading
def connector
  @connector ||= ::MellonConnector.new
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE implemente** seguran√ßa por padr√£o - autentica√ß√£o sempre executada antes de opera√ß√µes
2. **SEMPRE use** lazy loading - depend√™ncias carregadas apenas quando necess√°rias
3. **SEMPRE use** memoiza√ß√£o - `||=` evita recria√ß√£o desnecess√°ria de objetos
4. **SEMPRE use** namespace completo - `::` previne conflitos de nomes

### 9.3 Padr√£o de Delega√ß√£o Limpa

**Contexto**: Separa√ß√£o clara entre coordena√ß√£o e execu√ß√£o

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Delega√ß√£o limpa para connector
def notifications(date)
  connector.notifications(date)
end

def notifications_with_error(date)
  connector.notifications_with_error(date)
end

def available_services(date)
  connector.available_services(date)
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE mantenha** interface consistente - mesma assinatura para m√©todos relacionados
2. **SEMPRE separe** responsabilidades - service coordena, connector executa
3. **SEMPRE garanta** manutenibilidade - mudan√ßas no connector n√£o afetam interface
4. **SEMPRE facilite** testabilidade - f√°cil mockar connector para testes

### 9.4 Padr√£o de Configura√ß√£o Condicional

**Contexto**: Controle de funcionalidade via configura√ß√£o externa

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Configura√ß√£o condicional com guard clause
def import_xml(xml_file, user)
  return unless Setting.sma_mellon_import_type&.upcase == 'XML'
  portfolio_xml_importer.import(xml_file, user)
end

# ‚úÖ CORRETO: Safe navigation para evitar erros
def import_xls(json, user)
  portfolio_json_importer.import(json, user)
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** configura√ß√£o externa - `Setting` permite controle sem c√≥digo
2. **SEMPRE implemente** guard clause - retorno antecipado para condi√ß√µes n√£o atendidas
3. **SEMPRE use** safe navigation - `&.upcase` previne erros de nil
4. **SEMPRE garanta** flexibilidade - funcionalidade pode ser habilitada/desabilitada

### 9.5 Padr√£o de M√©todos de Classe Utilit√°rios

**Contexto**: Opera√ß√µes que n√£o precisam de estado de inst√¢ncia

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: M√©todo de classe com inje√ß√£o de depend√™ncia
def self.front_office(opts, portfolio_clazz = Strategy::Portfolio)
  portfolio = portfolio_clazz.new(opts)
  portfolio.json_exchange_rates = true
  portfolio.load_front_positions(opts)
  portfolio
end

# ‚úÖ CORRETO: M√©todo de classe para c√°lculos
def self.average_nav_on_period(params)
  interval = params[:fund].business_date_calculator.advance(params[:date], -params[:period], :following) if params[:type] == :business_days
  interval = params[:date] - params[:period].days if interval.nil?

  Quote.where(security: params[:fund].fund_share)
       .where(' day >= ? ', interval)
       .average(:volume)
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** m√©todos sem estado - m√©todos que n√£o precisam de inst√¢ncia
2. **SEMPRE use** inje√ß√£o de depend√™ncia - classes injet√°veis como par√¢metros
3. **SEMPRE implemente** fluent interface - configura√ß√£o seguida de opera√ß√£o
4. **SEMPRE retorne** objeto √∫til - objeto configurado retornado para uso

### 9.6 Padr√£o de Factory Methods Privados

**Contexto**: Cria√ß√£o centralizada de depend√™ncias

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Factory methods privados com lazy loading
protected

def connector
  @connector ||= ::MellonConnector.new
end

def portfolio_json_importer
  ::Mellon::PortfolioJsonImporter.new
end

def portfolio_xml_importer
  ::Mellon::XmlPortfolioImporter.new
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** lazy loading - inst√¢ncias criadas apenas quando necess√°rias
2. **SEMPRE use** memoiza√ß√£o - `||=` evita recria√ß√£o desnecess√°ria
3. **SEMPRE use** namespace completo - `::` previne conflitos de nomes
4. **SEMPRE centralize** cria√ß√£o - factory pattern centraliza cria√ß√£o de depend√™ncias

### 9.7 Padr√£o de Broadcasting com ActionCable

**Contexto**: Comunica√ß√£o em tempo real via WebSockets

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Broadcasting via ActionCable
def self.broadcast_message(params)
  ActionCable.server.broadcast 'mellon_ws', params
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** m√©todo de classe - n√£o requer inst√¢ncia para uso
2. **SEMPRE use** ActionCable - integra√ß√£o nativa com WebSockets
3. **SEMPRE use** canal espec√≠fico - `mellon_ws` para comunica√ß√£o Mellon
4. **SEMPRE mantenha** tempo real - comunica√ß√£o ass√≠ncrona eficiente

**Aplica√ß√£o Futura**:

1. **SEMPRE use** namespaces para organizar services por dom√≠nio
2. **SEMPRE implemente** autentica√ß√£o autom√°tica na inicializa√ß√£o
3. **SEMPRE use** delega√ß√£o limpa para separar responsabilidades
4. **SEMPRE crie** factory methods privados para depend√™ncias
5. **SEMPRE use** configura√ß√£o externa para controle de funcionalidades
6. **SEMPRE implemente** guard clauses para condi√ß√µes
7. **SEMPRE use** safe navigation para evitar erros de nil
8. **SEMPRE crie** m√©todos de classe para opera√ß√µes sem estado
9. **SEMPRE use** inje√ß√£o de depend√™ncia para flexibilidade
10. **SEMPRE implemente** fluent interface para configura√ß√£o
11. **SEMPRE use** ActionCable para comunica√ß√£o em tempo real
12. **SEMPRE crie** canais espec√≠ficos por dom√≠nio
13. **SEMPRE implemente** m√©todos de classe para broadcasting
14. **SEMPRE mantenha** comunica√ß√£o ass√≠ncrona eficiente

## 10. Padr√µes de Arquitetura - Documenta√ß√£o Completa

**Contexto**: Sistema de carteiras padr√£o desenvolvido pela Investtools
para garantir uniformidade e consist√™ncia das informa√ß√µes financeiras.

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Estrutura modular do IVT Portfolio
# Portfolio/ - Classes principais
# ‚îú‚îÄ‚îÄ AbstractPortfolio - Classe base abstrata
# ‚îú‚îÄ‚îÄ PortfolioBack - Carteira de cust√≥dia
# ‚îî‚îÄ‚îÄ PortfolioFront - Carteira de estrat√©gia

# Explosion/ - Sistema de explos√£o
# ‚îú‚îÄ‚îÄ ExplosionHash - Explos√£o de fundos de fundos
# ‚îú‚îÄ‚îÄ ExplosionHashBack - Explos√£o para cust√≥dia
# ‚îî‚îÄ‚îÄ ExplosionHashFront - Explos√£o para estrat√©gia

# Factory/ - Cria√ß√£o de produtos
# ‚îú‚îÄ‚îÄ PortfolioFactory - Factory principal
# ‚îî‚îÄ‚îÄ ProductFactory - Factory de produtos espec√≠ficos
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** estrutura modular - separa√ß√£o clara entre Portfolio, Explosion e Factory
2. **SEMPRE use** heran√ßa inteligente - AbstractPortfolio como base comum
3. **SEMPRE implemente** explos√£o condicional - ExplosionHash para fundos de fundos
4. **SEMPRE use** factory pattern - cria√ß√£o centralizada de produtos espec√≠ficos
5. **SEMPRE padronize** fluxo - Fundo + Data ‚Üí Portfolio Type ‚Üí Explosion ‚Üí Factory ‚Üí JSON ‚Üí Kafka

### 10.2 Mellon Integration - Sistema Robusto de Integra√ß√£o

**Contexto**: Integra√ß√£o completa com BNY Mellon para importa√ß√£o de dados de portf√≥lio.

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Arquitetura Mellon Integration
class MellonConnector
  def authenticate
    # Autentica√ß√£o JWT com Mellon
  end

  def notifications(date)
    # Busca notifica√ß√µes por data
  end
end

class Mellon::PortfolioService < ApplicationService
  def initialize
    connector.authenticate
  end

  def import_xml(xml_file, user)
    return unless Setting.sma_mellon_import_type&.upcase == 'XML'
    portfolio_xml_importer.import(xml_file, user)
  end
end

# Jobs automatizados
DataImporterJob.perform_later # cron: 0 6 * * 2-6
ErrorReimporterJob.perform_later # cron: 0 7-8 * * 2-6
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE implemente** autentica√ß√£o autom√°tica - JWT na inicializa√ß√£o do service
2. **SEMPRE use** configura√ß√£o condicional - Setting para controle de funcionalidades
3. **SEMPRE implemente** jobs automatizados - Cron jobs para importa√ß√£o e reprocessamento
4. **SEMPRE use** WebSocket broadcasting - comunica√ß√£o em tempo real
5. **SEMPRE aplique** crit√©rios de sele√ß√£o - fundos Mellon ativos, n√£o conciliados, com identificador externo

### 10.3 Redemption Methods - An√°lise Completa de Estrat√©gias

**Contexto**: Sistema de sele√ß√£o autom√°tica de estrat√©gias de resgate baseado em caracter√≠sticas do fundo.

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Factory Pattern para estrat√©gias
class RedemptionMethodFactory
  def self.create(fund)
    case fund.strategy_type
    when 'lower_tax'
      LowerTaxRedemptionMethod.new(fund)
    when 'fifo'
      FifoRedemptionMethod.new(fund)
    when 'lifo'
      LifoRedemptionMethod.new(fund)
    when 'btg_pactual'
      BtgPactualRedemptionMethod.new(fund)
    else
      DefaultRedemptionMethod.new(fund)
    end
  end
end

# ‚úÖ CORRETO: Estrat√©gias espec√≠ficas
class LowerTaxRedemptionMethod < RedemptionMethod
  def calculate_redemption(amount, date)
    # L√≥gica espec√≠fica para menor tributa√ß√£o
  end
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** factory pattern - sele√ß√£o autom√°tica baseada em caracter√≠sticas
2. **SEMPRE implemente** estrat√©gias espec√≠ficas - cada m√©todo tem l√≥gica pr√≥pria
3. **SEMPRE crie** fallback inteligente - DefaultRedemptionMethod para casos n√£o mapeados
4. **SEMPRE mantenha** extensibilidade - f√°cil adi√ß√£o de novas estrat√©gias

### 10.4 Memory Optimization - Plano Detalhado de Otimiza√ß√£o

**Contexto**: Plano de otimiza√ß√£o de mem√≥ria para API portfolio_ws com alto consumo.

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Alternativa 1 - Processamento em Lotes (IMPLEMENTADA)
def positions
  total = {}

  # Processar cust√≥dias em lotes de 1000
  query_custodies.find_in_batches(batch_size: 1000) do |custody_batch|
    quotes = query_quotes_for_batch(custody_batch)
    owner_administrator_alias = query_oaas_for_batch(custody_batch)

    custody_batch.each do |custody|
      # Processar posi√ß√£o individual
      process_position(custody, quotes, owner_administrator_alias)
    end

    # Limpar refer√™ncias do lote
    custody_batch = nil
  end

  total
end

# ‚úÖ CORRETO: Alternativa 2 - Cache Inteligente (PROPOSTA)
def positions_with_cache
  Rails.cache.fetch("portfolio_positions_#{fund_id}_#{date}", expires_in: 1.hour) do
    calculate_positions
  end
end

# ‚úÖ CORRETO: Alternativa 3 - Streaming (PROPOSTA)
def positions_streaming
  Enumerator.new do |yielder|
    query_custodies.find_each(batch_size: 500) do |custody|
      yielder << process_position(custody)
    end
  end
end
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE implemente** processamento em lotes - reduz consumo de mem√≥ria significativamente
2. **SEMPRE use** limpeza de refer√™ncias - `custody_batch = nil` libera mem√≥ria
3. **SEMPRE implemente** cache inteligente - evita rec√°lculos desnecess√°rios
4. **SEMPRE considere** streaming - processamento sob demanda
5. **SEMPRE monitore** m√©tricas - monitoramento de consumo de mem√≥ria

### 10.5 Testing Strategy - Estrat√©gia Abrangente de Testes

**Contexto**: Estrat√©gia completa de testes para RSpec e CoffeeScript/JavaScript.

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: RSpec - Testes unit√°rios, integra√ß√£o e sistema
RSpec.describe PortfolioService, type: :service do
  let(:fund) { create(:fund) }
  let(:portfolio_service) { described_class.new(fund) }

  describe '#positions' do
    it 'returns positions for the fund' do
      result = portfolio_service.positions
      expect(result).to be_a(Hash)
      expect(result.keys).to include(:total_value, :positions)
    end
  end
end

# ‚úÖ CORRETO: Teaspoon - Testes JavaScript/CoffeeScript
describe 'PortfolioService', ->
  beforeEach ->
    @fund = { id: 1, name: 'Test Fund' }
    @service = new PortfolioService(@fund)

  describe 'positions', ->
    it 'should return positions hash', ->
      result = @service.positions()
      expect(result).toBeDefined()
      expect(result.total_value).toBeDefined()
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** RSpec - testes unit√°rios, integra√ß√£o e sistema
2. **SEMPRE implemente** Teaspoon - 331 exemplos passando sem falhas
3. **SEMPRE use** Jasmine - framework de assertions para JavaScript
4. **SEMPRE use** AngularJS - framework frontend com mocks
5. **SEMPRE mantenha** cobertura - SimpleCov para m√©tricas de cobertura

### 10.6 API Endpoints - Documenta√ß√£o Completa de APIs

**Contexto**: Documenta√ß√£o completa de endpoints REST com autentica√ß√£o e rate limiting.

**Padr√£o Comprovado**:

```ruby
# ‚úÖ CORRETO: Autentica√ß√£o JWT com rate limiting
class Api::V1::BaseController < ApplicationController
  before_action :authenticate_user!
  before_action :check_rate_limit

  private

  def check_rate_limit
    rate_limit = 1000 # requests per hour
    # Implementa√ß√£o de rate limiting
  end
end

# ‚úÖ CORRETO: Endpoints documentados
# GET /api/v1/funds - Lista fundos
# GET /api/v1/funds/:id - Detalhes do fundo
# GET /api/v1/assets - Lista ativos
# GET /api/v1/transactions - Lista transa√ß√µes
# GET /api/v1/quotes - Lista cota√ß√µes
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE implemente** autentica√ß√£o JWT - seguran√ßa robusta
2. **SEMPRE use** rate limiting - 1000 requests/hora
3. **SEMPRE siga** endpoints REST - padr√£o RESTful
4. **SEMPRE documente** - Swagger/OpenAPI
5. **SEMPRE version** - API versionada (v1)

**Aplica√ß√£o Futura**:

1. **SEMPRE use** estrutura modular para sistemas complexos
2. **SEMPRE implemente** heran√ßa inteligente com classes base
3. **SEMPRE use** factory pattern para cria√ß√£o de objetos
4. **SEMPRE padronize** fluxos de dados (Fundo ‚Üí Portfolio ‚Üí Explosion ‚Üí Factory ‚Üí JSON ‚Üí Kafka)
5. **SEMPRE implemente** autentica√ß√£o autom√°tica em services
6. **SEMPRE use** configura√ß√£o externa para controle de funcionalidades
7. **SEMPRE implemente** jobs automatizados com cron
8. **SEMPRE use** WebSocket para comunica√ß√£o em tempo real
9. **SEMPRE aplique** crit√©rios de sele√ß√£o inteligentes
10. **SEMPRE use** factory pattern para sele√ß√£o de estrat√©gias
11. **SEMPRE implemente** estrat√©gias espec√≠ficas para cada caso
12. **SEMPRE crie** fallback inteligente para casos n√£o mapeados
13. **SEMPRE mantenha** extensibilidade para novas estrat√©gias
14. **SEMPRE implemente** processamento em lotes para otimiza√ß√£o
15. **SEMPRE use** limpeza de refer√™ncias para liberar mem√≥ria
16. **SEMPRE implemente** cache inteligente para evitar rec√°lculos
17. **SEMPRE considere** streaming para processamento sob demanda
18. **SEMPRE monitore** m√©tricas de consumo de mem√≥ria
19. **SEMPRE use** RSpec para testes unit√°rios e integra√ß√£o
20. **SEMPRE implemente** Teaspoon para testes JavaScript/CoffeeScript
21. **SEMPRE use** Jasmine para assertions em JavaScript
22. **SEMPRE mantenha** cobertura de testes com SimpleCov
23. **SEMPRE implemente** autentica√ß√£o JWT em APIs
24. **SEMPRE use** rate limiting para prote√ß√£o de endpoints
25. **SEMPRE siga** padr√µes RESTful para APIs
26. **SEMPRE documente** endpoints com Swagger/OpenAPI
27. **SEMPRE version** APIs adequadamente

## 11. Comandos de Movimenta√ß√£o

### 11.1 Refinar e Mover para Regras Espec√≠ficas

```bash
# Refinar e mover para regras espec√≠ficas (processo integrado)
/move evolution

# Compactar ap√≥s movimenta√ß√£o
/compact evolution
```

## 12. Padr√µes de Autentica√ß√£o JWT - Spring Security 6

### 12.1 Implementa√ß√£o Completa de JWT com Spring Security 6

**Contexto**: Implementa√ß√£o de sistema de autentica√ß√£o JWT completo no Sistema Amanhecer

**Padr√£o Comprovado**:

```java
// ‚úÖ CORRETO: JwtTokenProvider com Spring Security 6
@Component
@Slf4j
public class JwtTokenProvider {

    @Value("${app.jwt.secret}")
    private String jwtSecret;

    @Value("${app.jwt.expiration}")
    private long jwtExpiration;

    public String generateToken(Authentication authentication) {
        log.info("JWT TOKEN PROVIDER - Generating token for user: {}", authentication.getName());

        UserDetails userDetails = (UserDetails) authentication.getPrincipal();
        Map<String, Object> claims = new HashMap<>();
        claims.put("authorities", userDetails.getAuthorities());
        claims.put("username", userDetails.getUsername());

        long startTime = System.currentTimeMillis();
        String token = createToken(claims, userDetails.getUsername());
        long executionTime = System.currentTimeMillis() - startTime;

        log.info("JWT TOKEN PROVIDER - Token generated successfully for user: {}, executionTime={}ms",
                userDetails.getUsername(), executionTime);

        return token;
    }
}
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE implemente** logs estrat√©gicos obrigat√≥rios - sempre implementar logs PRIMEIRO em componentes de seguran√ßa
2. **SEMPRE monitore** performance - medir tempo de gera√ß√£o e valida√ß√£o de tokens
3. **SEMPRE use** claims customizados - incluir authorities e informa√ß√µes do usu√°rio
4. **SEMPRE implemente** refresh tokens - renova√ß√£o sem re-login
5. **SEMPRE use** configura√ß√£o externa - application.properties para configura√ß√µes JWT

### 12.2 JwtAuthenticationFilter com Spring Security 6

**Contexto**: Filtro de autentica√ß√£o JWT integrado ao SecurityFilterChain

**Padr√£o Comprovado**:

```java
// ‚úÖ CORRETO: JwtAuthenticationFilter com Spring Security 6
@Component
@RequiredArgsConstructor
@Slf4j
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtTokenProvider jwtTokenProvider;
    private final UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                  FilterChain filterChain) throws ServletException, IOException {

        String requestURI = request.getRequestURI();
        String method = request.getMethod();

        log.debug("JWT AUTHENTICATION FILTER - Processing request: {} {}", method, requestURI);

        try {
            String jwt = getJwtFromRequest(request);

            if (jwt != null && jwtTokenProvider.validateToken(jwt)) {
                String username = jwtTokenProvider.getUsernameFromToken(jwt);
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);

                UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                SecurityContextHolder.getContext().setAuthentication(authentication);
                log.info("JWT AUTHENTICATION FILTER - User authenticated successfully: {} for request: {} {}",
                        username, method, requestURI);
            }

        } catch (Exception e) {
            log.error("JWT AUTHENTICATION FILTER - Error processing authentication for request: {} {}, error: {}",
                    method, requestURI, e.getMessage());
            SecurityContextHolder.clearContext();
        }

        filterChain.doFilter(request, response);
    }
}
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** OncePerRequestFilter - garantir execu√ß√£o √∫nica por requisi√ß√£o
2. **SEMPRE implemente** logs de auditoria - registrar tentativas de autentica√ß√£o e falhas
3. **SEMPRE trate** erros - limpar contexto em caso de falha
4. **SEMPRE configure** endpoints p√∫blicos - shouldNotFilter para endpoints p√∫blicos
5. **SEMPRE use** logs de debug - para troubleshooting

### 12.3 CustomUserDetailsService com Email como Username

**Contexto**: Sistema baseado em email em vez de username tradicional

**Padr√£o Comprovado**:

```java
// ‚úÖ CORRETO: CustomUserDetailsService com email como username
@Service
@RequiredArgsConstructor
@Slf4j
public class CustomUserDetailsService implements UserDetailsService {

    private final UserRepository userRepository;
    private final AdminRepository adminRepository;

    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        log.info("CUSTOM USER DETAILS SERVICE - Loading user details for username: {}", username);

        long startTime = System.currentTimeMillis();

        try {
            // Primeiro, tentar buscar como usu√°rio normal
            UserDetails userDetails = loadUser(username);
            if (userDetails != null) {
                long executionTime = System.currentTimeMillis() - startTime;
                log.info("CUSTOM USER DETAILS SERVICE - User details loaded successfully for user: {}, executionTime={}ms",
                        username, executionTime);
                return userDetails;
            }

            // Se n√£o encontrou como usu√°rio, tentar como administrador
            userDetails = loadAdmin(username);
            if (userDetails != null) {
                long executionTime = System.currentTimeMillis() - startTime;
                log.info("CUSTOM USER DETAILS SERVICE - Admin details loaded successfully for admin: {}, executionTime={}ms",
                        username, executionTime);
                return userDetails;
            }

            log.warn("CUSTOM USER DETAILS SERVICE - User not found: {}", username);
            throw new UsernameNotFoundException("Usu√°rio n√£o encontrado: " + username);

        } catch (UsernameNotFoundException e) {
            throw e;
        } catch (Exception e) {
            log.error("CUSTOM USER DETAILS SERVICE - Error loading user details for username: {}, error: {}",
                    username, e.getMessage());
            throw new UsernameNotFoundException("Erro ao carregar usu√°rio: " + username, e);
        }
    }
}
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** email como username - sistema moderno baseado em email
2. **SEMPRE implemente** fallback inteligente - buscar usu√°rio primeiro, depois admin
3. **SEMPRE monitore** performance - medir tempo de carregamento de usu√°rios
4. **SEMPRE implemente** logs de seguran√ßa - auditoria completa de tentativas de login
5. **SEMPRE trate** exce√ß√µes - UsernameNotFoundException espec√≠fica

### 12.4 SecurityConfig com Spring Security 6

**Contexto**: Configura√ß√£o moderna com SecurityFilterChain

**Padr√£o Comprovado**:

```java
// ‚úÖ CORRETO: SecurityConfig com Spring Security 6
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
@RequiredArgsConstructor
public class SecurityConfig {

    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authz -> authz
                        .requestMatchers("/actuator/health", "/actuator/info").permitAll()
                        .requestMatchers("/h2-console/**").permitAll()
                        .requestMatchers("/api/auth/**").permitAll()
                        .requestMatchers("/api/admin/**").hasRole("ADMIN")
                        .requestMatchers("/api/users/**").hasRole("USER")
                        .requestMatchers("/api/rabbits/**", "/api/herds/**").hasRole("USER")
                        .anyRequest().authenticated())
                .headers(headers -> headers.frameOptions().sameOrigin())
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE use** SecurityFilterChain - abordagem moderna do Spring Security 6
2. **SEMPRE configure** stateless sessions - JWT n√£o requer sess√µes
3. **SEMPRE use** Method Security - @EnableMethodSecurity para @PreAuthorize
4. **SEMPRE integre** JWT Filter - integra√ß√£o do filtro JWT na cadeia
5. **SEMPRE configure** roles espec√≠ficas - configura√ß√£o granular por endpoint

### 12.5 AuthController com Endpoints Completos

**Contexto**: Controller de autentica√ß√£o com login, logout, refresh e informa√ß√µes do usu√°rio

**Padr√£o Comprovado**:

```java
// ‚úÖ CORRETO: AuthController com endpoints completos
@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
@Slf4j
public class AuthController {

    private final AuthenticationManager authenticationManager;
    private final JwtTokenProvider jwtTokenProvider;

    @PostMapping("/login")
    public ResponseEntity<Map<String, Object>> login(@Valid @RequestBody LoginRequest loginRequest) {
        log.info("AUTH CONTROLLER - Login attempt for username: {}", loginRequest.getUsername());

        long startTime = System.currentTimeMillis();

        try {
            Authentication authentication = authenticationManager.authenticate(
                    new UsernamePasswordAuthenticationToken(
                            loginRequest.getUsername(),
                            loginRequest.getPassword()
                    )
            );

            String token = jwtTokenProvider.generateToken(authentication);
            String refreshToken = jwtTokenProvider.generateRefreshToken(loginRequest.getUsername());

            long executionTime = System.currentTimeMillis() - startTime;

            Map<String, Object> response = new HashMap<>();
            response.put("token", token);
            response.put("refreshToken", refreshToken);
            response.put("type", "Bearer");
            response.put("username", loginRequest.getUsername());
            response.put("authorities", authentication.getAuthorities());
            response.put("expiresIn", jwtTokenProvider.getJwtExpiration());

            log.info("AUTH CONTROLLER - Login successful for username: {}, executionTime={}ms",
                    loginRequest.getUsername(), executionTime);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            long executionTime = System.currentTimeMillis() - startTime;
            log.error("AUTH CONTROLLER - Login failed for username: {}, executionTime={}ms, error: {}",
                    loginRequest.getUsername(), executionTime, e.getMessage());

            Map<String, Object> errorResponse = new HashMap<>();
            errorResponse.put("error", "Credenciais inv√°lidas");
            errorResponse.put("message", "Usu√°rio ou senha incorretos");

            return ResponseEntity.status(401).body(errorResponse);
        }
    }
}
```

**Li√ß√µes Aprendidas**:

1. **SEMPRE crie** endpoints completos - login, logout, refresh, me
2. **SEMPRE monitore** performance - medir tempo de opera√ß√µes de autentica√ß√£o
3. **SEMPRE trate** erros - respostas padronizadas para falhas
4. **SEMPRE implemente** logs de auditoria - registrar tentativas de login e falhas
5. **SEMPRE implemente** refresh tokens - renova√ß√£o de tokens

**Aplica√ß√£o Futura**:

1. **SEMPRE implemente** logs estrat√©gicos PRIMEIRO em componentes de seguran√ßa
2. **SEMPRE use** Spring Security 6 com SecurityFilterChain moderno
3. **SEMPRE implemente** JWT com claims customizados e refresh tokens
4. **SEMPRE configure** autentica√ß√£o baseada em email
5. **SEMPRE implemente** auditoria completa de seguran√ßa
6. **SEMPRE use** OncePerRequestFilter para filtros JWT
7. **SEMPRE configure** endpoints p√∫blicos adequadamente
8. **SEMPRE implemente** fallback inteligente para usu√°rios e admins
9. **SEMPRE monitore** performance de opera√ß√µes de autentica√ß√£o
10. **SEMPRE trate** exce√ß√µes de seguran√ßa adequadamente
11. **SEMPRE configure** roles espec√≠ficas por endpoint
12. **SEMPRE implemente** Method Security com @PreAuthorize
13. **SEMPRE crie** endpoints completos de autentica√ß√£o
14. **SEMPRE implemente** logs de auditoria para compliance
15. **SEMPRE configure** refresh tokens para melhor UX

```bash
# Refinar e mover para regras espec√≠ficas (processo integrado)
/move evolution

# Compactar ap√≥s movimenta√ß√£o
/compact evolution
```
